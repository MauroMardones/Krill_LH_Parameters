---
title: "Krill Life Parammetrs estimation in a context spatial in WAP"
subtitle: "Supporting analysis to incorporate in Krill stock assessment frameworks"
author: "Mardones, M; Cárdenas, C."
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: seaice.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output:
  html_document:
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
editor_options: 
  markdown: 
    wrap: 72
---


```{r setup1}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      dev = 'jpeg',
                      dpi = 300)
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```



```{r lib, message=F, echo= TRUE}
library(here)
library(kableExtra)
library(ggthemes)
#analisis
library(ggpubr)
library(easystats) # multiples unciones analiticas
library(sf)
library(tidyverse, quietly = TRUE)
library(modelsummary)
library(terra) # replace raster
library(TropFishR)
```

# Background

# Methodology



A important piece of information for a stock evaluation refers to the biological components such as average sizes and weights across areas and years. To do this, we will explore the biological data and prepare the output to add it into stock assessment integrate model [@Methot2013].

The object `ohbio2` come from data exploration analysis in data request
CCAMLR data. This objetc have bio information from krill.

```{r  echo=FALSE}
#datos entregados por secretaria de CCMLAR
metadata <- load("~/DOCAS/Data/565_C1_KRI_2021-10-01/DATA_PRODUCT_565.RData")
# Data procesada por MMardones
#ohbio <- load("DataLengthKrill.RData")
#ohbio
#metadata
#son lo mismo
```

```{r}
#cargo objeto
meta <- get("METADATA")
c1 <- get("C1")
ohbio <- get("OBS_HAUL_BIOLOGY")
names(ohbio)
dim(c1)
dim(ohbio)
```


Join data set with master as `c1` set. This join is trought
`obs_haul_id` variable to get geoposition variables

```{r warning=FALSE}
ohbio2 <- left_join(c1, ohbio, by="obs_haul_id")
names(ohbio2)
```

Firsts glance. Test how many register have by year. In this case,
`length_total_cm` by season ccamlr. Same exercise in date period
`date_catchperiod_start` to separate dates.

```{r}
ohbio3 <- ohbio2 %>%
  mutate(Year = year(date_catchperiod_start),
         Month = month(date_catchperiod_start),
         Day = day(date_catchperiod_start)) %>% 
  #toupper() para convertir los valores a mayúsculas
  mutate(sex_code = toupper(sex_code))
```

Save data further analysis
```{r}
length481 <-ohbio3 %>% 
  dplyr::select(7, 9, 11, 12, 14, 24, 25, 29, 42, 44, 46, 47, 43, 45) %>% 
  filter(asd_code=="481")
summary(length481)  
#save(length481, file = "length481.RData")
```

Filter data regarding to previous glances. Follow with a quick glimpse
to all 48 subarea length composition from monitoring fisheries (Figure
\@ref(fig:lenthtrwal)).

```{r lenthtrwal, message=F, warning=F, fig.cap="Krill length by Trawl technique"}

jz <- ggplot(length481 %>% 
               dplyr::filter(Year>2000),
             aes(x=length_total_cm, 
                 y = as.factor(Month), 
                 fill=asd_code))+
  #geom_joy(alpha=0.9) +
  geom_density_ridges(stat = "binline", bins = 50, 
                      scale = 1.8, 
                      draw_baseline = FALSE,
                      alpha=0.8)+
  facet_wrap(Year~.) +   
  geom_vline(xintercept = 3.6, color = "red")+
  scale_x_continuous(breaks = seq(from = 1, to = 10, 
                                  by = 1))+
  scale_y_discrete(breaks = seq(from = 2000, 
                                to = 2020, by = 1))+
  scale_fill_viridis_d(name="SubArea",
                       option="F")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1))+
  xlim(0,10)+
  xlab("Longitud (cm.)")+
  ylab("")
jz
```


First thing is get different rater layer to join krill data length
according different porpoises.

```{r raster}
# Uso las agrupaciones de Strata
strata <- st_read("~/DOCAS/Mapas/Antarctic_SHPfiles/Strata.shp",
                quiet=T)
strata=st_transform(strata, "+proj=latlong +ellps=WGS84")
```
Test Strata SSMU, just to know another way to join data, but this kind of spatial structuration is deprecated to mamagemente use (Figure\@ref(fig:maptest2).



## Grouping bio data into stratas

```{r ssmu1}
names(length481)
ohbio6 <- st_as_sf(length481 %>% 
                     drop_na(latitude_set_end), 
                   coords = c("longitude_set_end", "latitude_set_end"),  
                  crs = "+proj=latlong +ellps=WGS84")
```


Length composition by Strata CCAMLR to visualization first. First step is group data into to poligons strata.

```{r wranlingdata}
strata <- st_make_valid(strata)
sf4 <- st_join(strata, ohbio6)
```


scattter plot lenght data
```{r warning=F}
lentraplot <- ggplot(sf4 %>% 
                   filter(Year>2000,
                      ID !="Outer"), 
               aes(Year, tapro,
               fill=Month))+
    geom_point(alpha=0.3, 
               shape=21, 
               show.legend = T) +
    scale_fill_viridis_c(option="G")+
    geom_hline(yintercept = 4.16,
               color = "black",
               linetype  = 2)+
    stat_smooth(method = "loess",
                col="red")+
    theme_bw()+ 
    facet_wrap(.~ID)+
    theme(axis.text.x = element_text(angle = 90, hjust = 2))+
    guides(fill = guide_legend(reverse=F))+
    
    ylab("") +
    xlab("") 
lentraplot
```
histogram length data


```{r warning=FALSE}
jzstrata <- ggplot(sf4 %>% 
               filter(Year>2010,
                      ID !="Outer"),
             aes(x=length_total_cm, 
                 y = as.factor(Month), 
                 fill=ID))+
  geom_density_ridges(stat = "binline", bins = 30, 
                      scale = 1.9, 
                      draw_baseline = FALSE,
                      alpha=0.9)+
  facet_grid(Year~ID) +   
  geom_vline(xintercept = 3.6, color = "red")+
  scale_x_continuous(breaks = seq(from = 1, to = 10, 
                                  by = 2))+
  scale_y_discrete(breaks = seq(from = 1, 
                                to = 12, by = 4))+
  scale_fill_viridis_d(name="Strata",
                       option="F")+
  theme_few()+
  xlab("Length (cm.)")+
  ylab("")
jzstrata
```
Now, must filter the DF

```{r}
sf5 <- sf4 %>% 
  dplyr::select(c("ID",
        "date_catchperiod_start",
        "length_total_cm",
        "Year",
        "Month",
        "sex_code",
         "greenweight_kg")) %>% 
  mutate(ID = if_else(ID == "Extra", "GERLASHE", ID)) %>% 
  filter(ID !="Outer") %>% 
  data.frame()
```
relacion Logitud peso


```{r}
cols <- c("M" = "darkgreen", "F" = "orange")

RL <- ggplot(sf5 %>% 
               filter(sex_code %in% c("M", "F"),
                      greenweight_kg<0.004),
             aes(x=length_total_cm,
                  y=greenweight_kg,
                 colour=sex_code))+
  geom_point()+
  stat_smooth(method = "loess", 
              fullrange = TRUE, se = FALSE) + 
  scale_colour_manual(values=cols)+
  facet_wrap(.~ID)+
  theme_few()
RL
```

```{r}
sf5test <- sf5 %>%
  mutate(date_catchperiod_start = as.Date(date_catchperiod_start)) %>%  # Asegurar que la columna de fechas sea de tipo Date
  mutate(Yearly_Group = floor_date(date_catchperiod_start, "year")) %>%  # Crear una nueva columna con la fecha agrupada mensualmente
  drop_na(length_total_cm) 



lfq1new <- lfqCreate(data = sf5test,
                     Lname = "length_total_cm", 
                     Dname = "Yearly_Group",
                     bin_size = 0.1)

synLFQ7a <- lfqModify(lfq1new, bin_size = 0.2)

plot(synLFQ7a, Fname = "catch")
```


```{r}
# plot raw and restructured LFQ data
lfqbin <- lfqRestructure(lfq1new , MA = 5, addl.sqrt = TRUE)
opar <- par(mfrow = c(2,1), mar = c(2,5,2,3), oma = c(2,0,0,0))
plot(lfqbin, Fname = "catch", date.axis = "modern")
plot(lfqbin, Fname = "rcounts", date.axis = "modern")
par(opar)
```
```{r}
# Response surface analyss
res_RSA <- ELEFAN(lfq1new, Linf_range = seq(45,50,1), MA = 5,
                  K_range = seq(0.01,2,0.1), addl.sqrt = TRUE,
                  hide.progressbar = TRUE, contour=5)

# show results
res_RSA$par; res_RSA$Rn_max




# run ELEFAN with simulated annealing
res_SA <- ELEFAN_SA(lfq1new, SA_time = 60*0.5, SA_temp = 6e5,
                    MA = 5, seasonalised = TRUE, addl.sqrt = TRUE,
                    init_par = list(Linf = 49, 
                                    K = 0.5, 
                                    t_anchor = 0.5,
                                    C=0.5, ts = 0.5),
                    low_par = list(Linf = 45, K = 0.01, t_anchor = 0, C = 0, ts = 0),
                    up_par = list(Linf = 50, K = 1, t_anchor = 1, C = 1, ts = 1))
# show results
res_SA$par; res_SA$Rn_max


# run ELEFAN with genetic algorithm
res_GA <- ELEFAN_GA(lfq1new, MA = 5, seasonalised = TRUE, maxiter = 10, 
                    addl.sqrt = TRUE,
                    low_par = list(Linf = 45, K = 0.01, t_anchor = 0, C = 0, ts = 0),
                    up_par = list(Linf = 50, K = 1, t_anchor = 1, C = 1, ts = 1),
                    monitor = FALSE)
# show results
res_GA$par; res_GA$Rn_max
```


```{r}
# plot LFQ and growth curves
plot(lfqbin, Fname = "rcounts",date.axis = "modern", ylim=c(0,8))
lt <- lfqFitCurves(lfq1new, par = list(Linf=4.9, K=0.2, 
                                       t_anchor=0.25, C=0.3, ts=0),
                   draw = TRUE, col = "grey", lty = 1, lwd=1.5)

```

gener

# References


